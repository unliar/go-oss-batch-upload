name: go
on:
  push:
    tags:
      - "*"
jobs:
  build:
    name: build&&push
    runs-on: ubuntu-latest
    env:
      REGISTRY: "registry.cn-shenzhen.aliyuncs.com"
    steps:
      - name: "Â§çÂà∂Êñá‰ª∂"
        uses: actions/checkout@v1

      - name: "ÂÆπÂô®ÊûÑÂª∫"
        run: |
          docker login --username=${{ secrets.DOCKER_USERNAME }} $REGISTRY --password=${{ secrets.DOCKER_PASSWORD }}
          TAG="happysooner/go-oss-batch-upload:${{ github.ref_name }}"
          echo $TAG
          docker build -t go-oss-batch-upload:latest .
          docker tag go-oss-batch-upload:latest $REGISTRY/$TAG
          docker push $REGISTRY/$TAG

      - name: "Build and Package Binaries"
        run: |
          mkdir -p release
          for os in linux darwin windows; do
            for arch in amd64 arm64; do
              GOOS=$os GOARCH=$arch go build -o release/main-$os-$arch ./...  # Adjust 'myapp' to your app's name
            done
          done

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            Release notes for version ${{ github.ref }}
          files:
            - release/main-* # Include all binaries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: feishu-bot-message
        if: always()
        uses: foxundermoon/feishu-action@v2
        with:
          url: ${{ secrets.FEISHU_BOT_WEBHOOK_URL }}
          msg_type: text
          content: |
            text: |
              üê≥ ÊûÑÂª∫Áä∂ÊÄÅ - From Github Action 

              repository: https://github.com/${{ github.repository }}

              committer: https://github.com/${{ github.actor }}

              compare: ${{ github.event.compare }}

              job status: ${{ job.status }}
