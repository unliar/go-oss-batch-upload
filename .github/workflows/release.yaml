name: go
on:
  push:
    tags:
      - "*"
jobs:
  build:
    name: build&&push
    runs-on: ubuntu-latest
    env:
      REGISTRY: "registry.cn-shenzhen.aliyuncs.com"
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4 # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬

      - name: "Extract tag name"
        id: extract_tag
        run: |
          echo "tag_name=$(echo ${{ github.ref_name }} | sed 's/refs\/tags\///')" >> $GITHUB_OUTPUT

      - name: "å®¹å™¨æ„å»º"
        run: |
          docker login --username=${{ secrets.DOCKER_USERNAME }} $REGISTRY --password=${{ secrets.DOCKER_PASSWORD }}
          TAG="happysooner/go-oss-batch-upload:${{ steps.extract_tag.outputs.tag_name }}"
          echo $TAG
          docker build -t go-oss-batch-upload:latest .
          docker tag go-oss-batch-upload:latest $REGISTRY/$TAG
          docker push $REGISTRY/$TAG

      - name: "Build and Package Binaries"
        run: |
          mkdir -p release
          for os in linux darwin windows; do
            for arch in amd64 arm64; do
              GOOS=$os GOARCH=$arch go build -o release/main-$os-$arch .   
              chmod +x release/main-$os-$arch
              echo "release/main-$os-$arch" >> $GITHUB_FILES_ENV   
            done
          done

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract_tag.outputs.tag_name }}
          release_name: ${{ steps.extract_tag.outputs.tag_name }} # æ›´ç®€æ´
          body: |
            Release notes for version ${{ steps.extract_tag.outputs.tag_name }}
          files: $GITHUB_FILES_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: feishu-bot-message
        uses: foxundermoon/feishu-action@v2
        with:
          url: ${{ secrets.FEISHU_BOT_WEBHOOK_URL }}
          msg_type: text
          content: |
            ğŸ³ æ„å»ºçŠ¶æ€ - From Github Action

            repository: https://github.com/${{ github.repository }}

            committer: https://github.com/${{ github.actor }}

            compare: ${{ github.event.compare }}

            job status: ${{ job.status }}
